<!DOCTYPE html>
<html>
<head>
    <title>ダッシュボード - {{ school.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/dashboard.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand">
                <strong>{{ school.name }}</strong> CMS
            </span>
            <div class="d-flex align-items-center">
                <span class="text-light me-3">レイアウト: {{ slots_data|length }}分割</span>
                <a href="/logout" class="btn btn-outline-light btn-sm">ログアウト</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="text-center mb-3">
            <p class="text-muted">編集したいエリアをクリックしてください</p>
        </div>

        <div id="preview-grid" class="layout-{{ slots_data|length }}">
            
            {% for item in slots_data %}
            <div class="dashboard-slot slot-{{ item.slot.position }}" 
                 onclick="openEditModal('{{ item.slot.id }}', '{{ item.slot.content_type }}', '{{ item.content.body or '' }}')">
                
                <span class="slot-type-badge bg-{{ 'primary' if item.slot.content_type == 'notice' else 'warning' if item.slot.content_type == 'ad' else 'success' }}">
                    {{ item.slot.content_type }}
                </span>

                <div class="slot-preview">
                    {% if item.slot.content_type == 'ad' %}
                        <div class="text-white">
                            <i class="bi bi-collection-play"></i> スライドショー<br>
                            (自動配信)
                        </div>
                    {% elif item.slot.content_type == 'weather' %}
                        <div class="text-white">
                            天気予報<br>(自動配信)
                        </div>
                    {% elif item.content.media_url %}
                        <img src="{{ item.content.media_url }}">
                    {% elif item.content.body %}
                        {{ item.content.body }}
                    {% else %}
                        <span class="text-muted">（未設定）</span>
                    {% endif %}
                </div>

                <div class="edit-overlay">
                    <span class="edit-text">編集する</span>
                </div>
            </div>
            {% endfor %}

        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/update_content" method="post" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">コンテンツ編集</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="slot_id" id="modalSlotId">
                        
                        <div class="mb-3">
                            <label class="form-label">枠の種類:</label>
                            <span id="modalSlotType" class="badge bg-secondary"></span>
                            <p class="text-muted small" id="modalTypeDesc"></p>
                        </div>

                        <div id="formNotice" class="d-none">
                            <div class="mb-3">
                                <label class="form-label">メッセージ本文</label>
                                <textarea name="body" id="modalBody" class="form-control" rows="4"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">画像 (任意)</label>
                                <input type="file" name="file" class="form-control">
                            </div>
                        </div>

                        <div id="formAuto" class="d-none">
                            <div class="alert alert-info">
                                この枠はシステムまたは広告主によって自動配信されています。<br>
                                教員画面から個別の編集はできません。
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                        <button type="submit" id="submitBtn" class="btn btn-primary">更新して反映</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function openEditModal(slotId, contentType, currentBody) {
            // 値をセット
            document.getElementById('modalSlotId').value = slotId;
            document.getElementById('modalSlotType').innerText = contentType;
            
            // フォームの切り替え
            const formNotice = document.getElementById('formNotice');
            const formAuto = document.getElementById('formAuto');
            const submitBtn = document.getElementById('submitBtn');

            if (contentType === 'notice') {
                // お知らせの場合: 編集可能
                formNotice.classList.remove('d-none');
                formAuto.classList.add('d-none');
                submitBtn.disabled = false;
                
                // 現在の本文を入れる
                document.getElementById('modalBody').value = currentBody;
            } else {
                // 天気・広告の場合: 編集不可（案内のみ）
                formNotice.classList.add('d-none');
                formAuto.classList.remove('d-none');
                submitBtn.disabled = true; // ボタン無効化
            }

            // モーダルを表示
            var myModal = new bootstrap.Modal(document.getElementById('editModal'));
            myModal.show();
        }
    </script>
</body>
</html>