<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学校管理ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
    <!-- Interact.js for Drag & Drop / Resize -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    
    <style> 
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        
        /* スライド編集キャンバス (サイズはJSで制御) */
        .slide-canvas {
            width: 100%;
            /* aspect-ratioはJSで動的に設定します */
            background-color: #000;
            color: #fff;
            position: relative; /* 子要素をabsoluteにするため */
            overflow: hidden;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
            transition: aspect-ratio 0.3s ease;
        }

        /* ドラッグ可能な要素の共通スタイル */
        .draggable-item {
            position: absolute;
            box-sizing: border-box;
            user-select: none;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* はみ出し禁止 */
        }

        /* 選択・ホバー時の枠線 */
        .draggable-item:hover, .draggable-item.is-selected {
            outline: 2px dashed rgba(59, 130, 246, 0.8);
            cursor: move;
            z-index: 50; /* 操作中は手前に */
        }
        
        /* 画像要素 */
        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* アスペクト比維持ではみ出さない */
            pointer-events: none; /* 画像自体のドラッグを防ぐ */
        }

        /* テキスト要素 */
        .item-text {
            /* テキスト編集エリア */
            width: 100%;
            height: 100%;
            padding: 0.5rem;
            white-space: pre-wrap;
            word-break: break-word;
            outline: none;
            display: flex;
            flex-direction: column;
            justify-content: center; /* 垂直中央 */
            cursor: text;
        }
        /* ドラッグハンドルの上書き */
        .draggable-item.item-text:hover { cursor: move; }
        .item-text-inner { width: 100%; cursor: text; }

        /* ツールバー */
        .toolbar-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.3rem;
            transition: all 0.2s;
            color: #4b5563;
            border: 1px solid transparent;
        }
        .toolbar-btn:hover { background-color: #e5e7eb; color: #1f2937; }
        .toolbar-btn.active { background-color: #dbeafe; color: #2563eb; border-color: #bfdbfe; }
        .toolbar-group {
            display: flex; gap: 0.25rem; padding-right: 0.75rem; margin-right: 0.75rem; border-right: 1px solid #e5e7eb;
        }
        .toolbar-group:last-child { border-right: none; }

        .color-picker-wrapper { position: relative; overflow: hidden; }
        .color-input { position: absolute; left: -100%; top: -100%; width: 200%; height: 200%; cursor: pointer; opacity: 0; }

        /* 左側のミニプレビュー */
        .mini-slot {
            position: relative; overflow: hidden; cursor: pointer;
            border: 2px solid transparent; transition: all 0.2s;
            background-color: #000; color: white;
            display: flex; justify-content: center; align-items: center;
        }
        .mini-slot:hover { border-color: #60a5fa; }
        .mini-slot.active { border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3); z-index: 10; }
        .mini-slot-label {
            position: absolute; top: 2px; left: 2px; font-size: 10px;
            background: rgba(0,0,0,0.6); padding: 1px 4px; border-radius: 2px;
            pointer-events: none; z-index: 20;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    
    <!-- Header -->
    <nav class="bg-slate-800 text-white shadow-md z-50 shrink-0">
        <div class="px-6 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-tv text-blue-400 text-xl"></i>
                <div>
                    <h1 class="font-bold text-lg leading-tight">{{ school.name }}</h1>
                    <p class="text-xs text-gray-400">デジタルサイネージ管理</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/admin/ads" class="flex items-center text-sm bg-yellow-600 hover:bg-yellow-700 px-3 py-1.5 rounded transition shadow-sm font-bold mr-2">
                    <i class="fa-solid fa-rectangle-ad mr-2"></i> 広告管理
                </a>
                <div id="connection-status" class="w-3 h-3 rounded-full bg-red-500" title="Server Connection"></div>
                <a href="/logout" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-sm transition">
                    <i class="fa-solid fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="flex flex-grow overflow-hidden">
        
        <!-- Left: Layout Preview & Selector -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col shrink-0 z-20 shadow-lg">
            <div class="p-4 border-b border-gray-200 bg-gray-50">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1"><i class="fa-solid fa-table-cells mr-1"></i> 全体プレビュー</h2>
                <p class="text-[10px] text-gray-400">編集したいエリアをクリックしてください</p>
            </div>
            
            <div class="p-4 flex-grow overflow-y-auto bg-gray-100 flex flex-col items-center">
                <!-- TV Frame for Mini Preview -->
                <div class="w-full bg-gray-800 p-2 rounded-lg shadow-xl mb-4">
                    <div id="mini-preview-grid" class="w-full aspect-video bg-black grid gap-0.5 relative">
                        <!-- JSでここにグリッドを生成 -->
                    </div>
                </div>
                
                <div class="w-full bg-white p-3 rounded border border-gray-200 text-xs text-gray-500">
                    <p class="mb-1 font-bold">現在の選択:</p>
                    <p id="selected-slot-info" class="text-blue-600 font-bold text-sm">-</p>
                    <p id="selected-slot-ratio" class="text-gray-400 text-[10px] mt-1">アスペクト比: -</p>
                </div>
            </div>
        </div>

        <!-- Center: Editor Canvas -->
        <div class="flex-grow bg-gray-200 flex flex-col relative">
            
            <!-- Toolbar -->
            <div id="editor-toolbar" class="bg-white border-b border-gray-200 px-4 py-2 flex items-center shadow-sm z-10 transition-opacity duration-200 overflow-x-auto">
                
                <!-- 色設定 -->
                <div class="toolbar-group">
                    <div class="relative toolbar-btn color-picker-wrapper" title="文字色">
                        <i class="fa-solid fa-font"></i>
                        <div class="h-1 w-6 rounded-full mt-0.5" id="tool-text-color-indicator" style="background-color: white; border:1px solid #ddd;"></div>
                        <input type="color" id="tool-text-color" class="color-input" oninput="applyStyle('color', this.value)">
                    </div>
                    <div class="relative toolbar-btn color-picker-wrapper" title="背景色">
                        <i class="fa-solid fa-fill-drip"></i>
                        <div class="h-1 w-6 rounded-full mt-0.5" id="tool-bg-color-indicator" style="background-color: black; border:1px solid #ddd;"></div>
                        <input type="color" id="tool-bg-color" class="color-input" oninput="applyCanvasBg(this.value)">
                    </div>
                </div>

                <!-- 文字サイズ・太さ・配置 -->
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="applyStyle('fontSize', '1.5rem')" title="文字サイズ: 小"><span style="font-size: 10px">A</span></button>
                    <button class="toolbar-btn" onclick="applyStyle('fontSize', '3rem')" title="文字サイズ: 中"><span style="font-size: 14px">A</span></button>
                    <button class="toolbar-btn" onclick="applyStyle('fontSize', '5rem')" title="文字サイズ: 大"><span style="font-size: 18px">A</span></button>
                    <button class="toolbar-btn" onclick="applyStyle('fontWeight', 'bold')" title="太字"><i class="fa-solid fa-bold"></i></button>
                    <button class="toolbar-btn" onclick="applyStyle('textAlign', 'left')" title="左揃え"><i class="fa-solid fa-align-left"></i></button>
                    <button class="toolbar-btn" onclick="applyStyle('textAlign', 'center')" title="中央揃え"><i class="fa-solid fa-align-center"></i></button>
                    <button class="toolbar-btn" onclick="applyStyle('textAlign', 'right')" title="右揃え"><i class="fa-solid fa-align-right"></i></button>
                </div>

                <!-- 画像操作 -->
                <div class="toolbar-group">
                    <button class="toolbar-btn relative" onclick="document.getElementById('tool-image-upload').click()" title="画像挿入・変更">
                        <i class="fa-regular fa-image"></i>
                        <input type="file" id="tool-image-upload" class="hidden" accept="image/*" onchange="uploadImage(this)">
                    </button>
                    <button class="toolbar-btn text-red-500 hover:text-red-600" onclick="removeImage()" title="画像削除">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>

                <!-- 詳細設定 -->
                <div class="toolbar-group border-none">
                    <button class="toolbar-btn" onclick="document.getElementById('settings-modal').showModal()" title="スケジュール設定など">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-3 ml-auto">
                    <span id="save-status" class="text-xs text-gray-400 font-medium"></span>
                    <button onclick="saveCurrentSlot()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center">
                        <i class="fa-solid fa-cloud-arrow-up mr-2"></i> 保存
                    </button>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="flex-grow flex items-center justify-center p-8 overflow-hidden relative bg-gray-300" id="canvas-wrapper">
                
                <!-- The Slide Canvas -->
                <!-- Aspect RatioはJSで制御 -->
                <div id="editor-canvas" class="slide-canvas shadow-2xl">
                    
                    <!-- Draggable Image -->
                    <div id="drag-image" class="draggable-item item-image" style="top: 10%; left: 10%; width: 30%; height: 30%;">
                        <img id="editor-image" src="" alt="Image">
                    </div>

                    <!-- Draggable Text -->
                    <div id="drag-text" class="draggable-item item-text-container" style="top: 40%; left: 40%; width: 50%; height: 20%;">
                        <div id="editor-text" class="item-text" contenteditable="true" spellcheck="false">
                            テキストを入力...
                        </div>
                    </div>

                </div>

                <!-- Overlay for Auto Slots -->
                <div id="editor-locked-overlay" class="absolute inset-0 bg-gray-100/90 z-20 flex flex-col items-center justify-center hidden">
                    <i class="fa-solid fa-robot text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-600">自動配信枠</h3>
                    <p class="text-gray-500 mt-2">この枠の内容はシステムが自動的に更新します。</p>
                </div>

            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <dialog id="settings-modal" class="p-0 rounded-xl shadow-2xl w-full max-w-md backdrop:bg-gray-900/50">
        <div class="bg-white rounded-xl overflow-hidden">
            <div class="bg-slate-800 text-white px-6 py-4 flex justify-between items-center">
                <h3 class="font-bold">詳細設定</h3>
                <button onclick="document.getElementById('settings-modal').close()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">掲載期間</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-xs text-gray-500">開始</span>
                            <input type="text" id="setting-start-at" class="flatpickr w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">終了</span>
                            <input type="text" id="setting-end-at" class="flatpickr w-full border rounded p-2 text-sm">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">テーマ</label>
                    <select id="setting-theme" class="w-full border rounded p-2 text-sm">
                        <option value="default">標準</option>
                        <option value="urgent">緊急 (赤背景)</option>
                        <option value="happy">お祝い (明るい)</option>
                    </select>
                </div>
                <div class="pt-4 border-t flex justify-end">
                    <button onclick="document.getElementById('settings-modal').close()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">閉じる</button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Data Store -->
    <script>
        const slotsData = {{ slots_data | tojson }};
        const currentSchoolId = "{{ school.id }}";
        const currentLayoutType = {{ school.layout_type }};
        let currentSlotId = null;
        let currentFile = null;

        // レイアウト定義 (Grid数, SlotごとのSpan) からアスペクト比を計算
        // 画面全体は 16:9 とする
        const LAYOUT_DEFINITIONS = {
            1: { grid: [1, 1], slots: [[1,1]] },
            2: { grid: [2, 1], slots: [[1,1], [1,1]] },
            3: { grid: [3, 1], slots: [[1,1], [1,1], [1,1]] },
            4: { grid: [2, 2], slots: [[1,1], [1,1], [1,1], [1,1]] },
            5: { grid: [6, 2], slots: [[3,1], [3,1], [2,1], [2,1], [2,1]] },
            6: { grid: [3, 2], slots: [[1,1], [1,1], [1,1], [1,1], [1,1], [1,1]] },
            12: { grid: [1, 4], slots: [[1,3], [1,1]] },
            13: { grid: [3, 2], slots: [[2,2], [1,1], [1,1]] },
            14: { grid: [3, 3], slots: [[3,2], [1,1], [1,1], [1,1]] },
            15: { grid: [4, 3], slots: [[4,2], [1,1], [1,1], [1,1], [1,1]] },
            16: { grid: [4, 4], slots: [[3,4], [1,1], [1,1], [1,1], [1,1]] }
        };

        document.addEventListener('DOMContentLoaded', () => {
            flatpickr(".flatpickr", { enableTime: true, dateFormat: "Y-m-d H:i", locale: "ja", time_24hr: true });
            
            // Interact.js 設定 (ドラッグ & リサイズ)
            setupInteract('.draggable-item');

            renderMiniPreview();
            if (slotsData.length > 0) selectSlot(slotsData[0].slot.id);
            connectWs();
        });

        // --- Interact.js Logic ---
        function setupInteract(selector) {
            interact(selector)
                .draggable({
                    inertia: true,
                    modifiers: [
                        interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true })
                    ],
                    autoScroll: true,
                    listeners: { move: dragMoveListener }
                })
                .resizable({
                    edges: { left: true, right: true, bottom: true, top: true },
                    modifiers: [
                        interact.modifiers.restrictEdges({ outer: 'parent' }),
                        interact.modifiers.restrictSize({ min: { width: 50, height: 50 } })
                    ],
                    listeners: { move: resizeMoveListener }
                });
        }

        function dragMoveListener(event) {
            const target = event.target;
            // データ属性に保存された位置情報 (pixel)
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

            // translateで移動
            target.style.transform = `translate(${x}px, ${y}px)`;

            // 座標更新
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }

        function resizeMoveListener(event) {
            const target = event.target;
            let x = (parseFloat(target.getAttribute('data-x')) || 0);
            let y = (parseFloat(target.getAttribute('data-y')) || 0);

            // サイズ更新
            target.style.width = event.rect.width + 'px';
            target.style.height = event.rect.height + 'px';

            // 位置更新 (左上方向へのリサイズ時など)
            x += event.deltaRect.left;
            y += event.deltaRect.top;

            target.style.transform = `translate(${x}px, ${y}px)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }

        // --- Editor Logic ---

        function selectSlot(slotId) {
            currentSlotId = slotId;
            document.querySelectorAll('.mini-slot').forEach(el => el.classList.remove('active'));
            const miniSlot = document.getElementById(`mini-slot-${slotId}`);
            if(miniSlot) miniSlot.classList.add('active');

            const data = slotsData.find(d => d.slot.id === slotId);
            if (!data) return;

            const slot = data.slot;
            const content = data.content || {};
            const style = content.style_config || {};
            const elements = style.elements || {}; // 要素ごとの配置情報

            document.getElementById('selected-slot-info').innerText = `枠 ${slot.position + 1}: ${getContentLabel(slot.content_type)}`;

            // アスペクト比の計算と適用
            const def = LAYOUT_DEFINITIONS[currentLayoutType] || LAYOUT_DEFINITIONS[1];
            const slotDef = def.slots[slot.position] || [1, 1]; // [colSpan, rowSpan]
            const gridW = 16, gridH = 9;
            const ratioW = (gridW / def.grid[0]) * slotDef[0];
            const ratioH = (gridH / def.grid[1]) * slotDef[1];
            const aspectRatio = ratioW / ratioH;
            
            const canvas = document.getElementById('editor-canvas');
            canvas.style.aspectRatio = `${ratioW} / ${ratioH}`;
            document.getElementById('selected-slot-ratio').innerText = `アスペクト比: ${ratioW.toFixed(2)} : ${ratioH.toFixed(2)}`;

            // 要素の復元 (パーセント -> ピクセル変換は表示時に行うのが理想だが、
            // InteractJSはtranslate(px)を使うため、初期配置時に計算が必要)
            
            // Canvasサイズ取得 (レンダリング待ち)
            setTimeout(() => {
                const cw = canvas.clientWidth;
                const ch = canvas.clientHeight;

                restoreElement(document.getElementById('drag-text'), elements.text, cw, ch, 'text');
                restoreElement(document.getElementById('drag-image'), elements.image, cw, ch, 'image');
            }, 50);

            // 内容の復元
            const textEl = document.getElementById('editor-text');
            textEl.innerText = content.body || 'テキストを入力...';
            // テキストスタイル
            const tStyle = elements.text || {};
            textEl.style.color = tStyle.color || '#ffffff';
            textEl.style.fontSize = tStyle.fontSize || '2rem';
            textEl.style.fontWeight = tStyle.fontWeight || 'normal';
            textEl.style.textAlign = tStyle.textAlign || 'center'; // コンテナ内のテキスト配置

            // ツールバー同期
            document.getElementById('tool-text-color').value = rgbToHex(textEl.style.color);
            document.getElementById('tool-text-color-indicator').style.backgroundColor = textEl.style.color;

            // 背景色
            const bgColor = style.bg_color || '#000000';
            canvas.style.backgroundColor = bgColor;
            document.getElementById('tool-bg-color').value = rgbToHex(bgColor);
            document.getElementById('tool-bg-color-indicator').style.backgroundColor = bgColor;

            // 画像
            const imgEl = document.getElementById('editor-image');
            const dragImg = document.getElementById('drag-image');
            if (content.media_url) {
                imgEl.src = content.media_url;
                dragImg.style.display = 'flex';
            } else {
                imgEl.src = '';
                dragImg.style.display = 'none';
            }

            // スケジュール設定
            document.getElementById('setting-start-at')._flatpickr.setDate(content.start_at || '');
            document.getElementById('setting-end-at')._flatpickr.setDate(content.end_at || '');
            document.getElementById('setting-theme').value = content.theme || 'default';

            currentFile = null;
            document.getElementById('tool-image-upload').value = '';
        }

        function restoreElement(el, data, containerW, containerH, type) {
            // デフォルト値
            let left = 10, top = 10, width = 80, height = 30;
            if (type === 'image') { top = 40; height = 50; }
            if (data) {
                left = parseFloat(data.left);
                top = parseFloat(data.top);
                width = parseFloat(data.width);
                height = parseFloat(data.height);
            }

            // % -> px
            const x = (left / 100) * containerW;
            const y = (top / 100) * containerH;
            const w = (width / 100) * containerW;
            const h = (height / 100) * containerH;

            el.style.width = w + 'px';
            el.style.height = h + 'px';
            el.style.transform = `translate(${x}px, ${y}px)`;
            el.setAttribute('data-x', x);
            el.setAttribute('data-y', y);
        }

        // --- Helper ---
        function rgbToHex(rgb) {
            if (!rgb || rgb.startsWith('#')) return rgb;
            const sep = rgb.indexOf(",") > -1 ? "," : " ";
            const rgbvals = rgb.substr(4).split(")")[0].split(sep);
            let r = (+rgbvals[0]).toString(16), g = (+rgbvals[1]).toString(16), b = (+rgbvals[2]).toString(16);
            if (r.length == 1) r = "0" + r;
            if (g.length == 1) g = "0" + g;
            if (b.length == 1) b = "0" + b;
            return "#" + r + g + b;
        }

        function applyCanvasBg(val) {
            document.getElementById('editor-canvas').style.backgroundColor = val;
            document.getElementById('tool-bg-color-indicator').style.backgroundColor = val;
        }

        function applyStyle(prop, val) {
            const textEl = document.getElementById('editor-text');
            textEl.style[prop] = val;
            if (prop === 'color') document.getElementById('tool-text-color-indicator').style.backgroundColor = val;
        }

        function uploadImage(input) {
            if (input.files && input.files[0]) {
                currentFile = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('editor-image');
                    img.src = e.target.result;
                    document.getElementById('drag-image').style.display = 'flex';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage() {
            currentFile = 'DELETE';
            document.getElementById('drag-image').style.display = 'none';
            document.getElementById('tool-image-upload').value = '';
        }

        // --- Saving ---
        async function saveCurrentSlot() {
            if (!currentSlotId) return;
            const btn = document.querySelector('button[onclick="saveCurrentSlot()"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            const canvas = document.getElementById('editor-canvas');
            const cw = canvas.clientWidth;
            const ch = canvas.clientHeight;

            // 要素の位置・サイズを％に変換して保存
            const getElementData = (id) => {
                const el = document.getElementById(id);
                const x = parseFloat(el.getAttribute('data-x')) || 0;
                const y = parseFloat(el.getAttribute('data-y')) || 0;
                const w = parseFloat(el.style.width);
                const h = parseFloat(el.style.height);
                return {
                    left: (x / cw) * 100,
                    top: (y / ch) * 100,
                    width: (w / cw) * 100,
                    height: (h / ch) * 100
                };
            };

            const textEl = document.getElementById('editor-text');
            const textStyle = {
                ...getElementData('drag-text'),
                color: textEl.style.color,
                fontSize: textEl.style.fontSize,
                fontWeight: textEl.style.fontWeight,
                textAlign: textEl.style.textAlign
            };
            const imageStyle = getElementData('drag-image');

            // サーバーへ送信するための構造体
            const elementsConfig = {
                text: textStyle,
                image: imageStyle
            };

            const formData = new FormData();
            formData.append('slot_id', currentSlotId);
            
            let bodyText = textEl.innerText;
            if (bodyText === 'テキストを入力...') bodyText = '';
            formData.append('body', bodyText);

            // スタイル (Elements情報も含めてJSON文字列化して送る必要があるが、
            // 既存のバックエンドロジックはフラットなフォームデータを受け取って style_config を構築している。
            // ここでは簡易的に style_config 全体をJSON文字列として送るか、
            // 既存APIに合わせてパラメータを追加する。今回は互換性維持のため、
            // 特殊なキー "style_elements_json" を送ってバックエンドでパースさせるか、
            // フォームフィールドを増やす。
            // 既存のAPIロジックではカスタムフィールドを受け取れないため、
            // style_config に直接入れるハックとして、style_configのフィールドを上書きする。
            
            // ★バックエンド側で未定義のフォームフィールドを受け取るのは難しいので、
            // `style_justify_content` という既存の（しかし不要になった）フィールドを拝借して
            // JSON文字列を詰め込むハックを使うか、API側を修正する。
            // → 今回はAPI側も修正する前提で、JSON文字列を送る。
            
            formData.append('style_bg_color', canvas.style.backgroundColor);
            formData.append('elements_json', JSON.stringify(elementsConfig)); // ★新規追加パラメータ

            // スケジュール等
            formData.append('start_at', document.getElementById('setting-start-at').value);
            formData.append('end_at', document.getElementById('setting-end-at').value);
            formData.append('theme', document.getElementById('setting-theme').value);

            if (currentFile) {
                if (currentFile === 'DELETE') formData.append('delete_image', 'true');
                else formData.append('file', currentFile);
            }

            try {
                const response = await fetch('/update_content', { method: 'POST', body: formData });
                if (response.ok) {
                    location.reload(); 
                } else {
                    alert('保存失敗');
                }
            } catch (e) {
                console.error(e);
                alert('エラー');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '保存';
            }
        }

        // --- Mini Preview (Simple Grid) ---
        function renderMiniPreview() {
            const container = document.getElementById('mini-preview-grid');
            const def = LAYOUT_DEFINITIONS[currentLayoutType] || LAYOUT_DEFINITIONS[1];
            
            // Gridクラス生成 (簡易)
            let gridClass = `grid-cols-${def.grid[0]}`; // RowsはCSS Gridの自動配置に任せるか、厳密に指定するか
            // Tailwindの動的クラスは効かないことがあるので、styleで書く
            container.style.display = 'grid';
            container.style.gridTemplateColumns = `repeat(${def.grid[0]}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${def.grid[1]}, 1fr)`;
            container.innerHTML = '';

            slotsData.forEach((item, index) => {
                const slot = item.slot;
                const sDef = def.slots[slot.position] || [1,1];
                const el = document.createElement('div');
                el.className = `mini-slot`;
                el.id = `mini-slot-${slot.id}`;
                el.onclick = () => selectSlot(slot.id);
                // Grid Span
                el.style.gridColumn = `span ${sDef[0]}`;
                el.style.gridRow = `span ${sDef[1]}`;
                
                // Style
                const content = item.content || {};
                const style = content.style_config || {};
                el.style.backgroundColor = style.bg_color || '#000';
                
                el.innerHTML = `<div class="mini-slot-label">枠${slot.position + 1}</div>`;
                if(content.media_url) el.innerHTML += `<img src="${content.media_url}" style="width:100%;height:100%;object-fit:cover;opacity:0.5">`;
                
                container.appendChild(el);
            });
        }

        function getContentLabel(type) {
            const map = { 'notice': 'お知らせ', 'weather': '天気予報', 'ad': '広告', 'bus': 'バス時刻表', 'train': '電車時刻表', 'countdown': 'カウントダウン', 'wbgt': '熱中症情報', 'emergency': '緊急連絡', 'club_result': '部活動', 'lost_found': '落とし物' };
            return map[type] || type;
        }

        function connectWs() {
            // (省略: 既存と同じ)
        }
    </script>
</body>
</html>