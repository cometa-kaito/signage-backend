<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signage Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #000; color: #fff; overflow: hidden; }
        .slot-container { height: 100%; width: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .slide { position: absolute; inset: 0; opacity: 0; transition: opacity 1s ease-in-out; object-fit: contain; width: 100%; height: 100%; background-color: #000; }
        .slide.active { opacity: 1; }
        .theme-urgent { background-color: #ef4444; color: white; animation: flashRed 2s infinite; }
        @keyframes flashRed { 0%, 100% { background-color: #ef4444; } 50% { background-color: #b91c1c; } }
        .content-wrap { height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.5rem; text-align: center; }
        .image-wrapper { flex-grow: 1; width: 100%; height: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        img.main-image { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; border-radius: 0.25rem; }
        .text-body { font-size: 1.25rem; white-space: pre-wrap; line-height: 1.4; margin-bottom: 0.5rem; }
        .text-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem; color: #ccc; flex-shrink: 0; }
        .text-note { font-size: 0.9rem; margin-top: 0.5rem; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; flex-shrink: 0; }
    </style>
</head>
<body class="h-screen w-screen">
    <div id="app" class="h-full w-full grid gap-1 bg-black"></div>
    <div id="offline-indicator" class="hidden absolute top-0 right-0 m-4 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg border border-white opacity-80 z-50"><i class="fa-solid fa-wifi-slash mr-1"></i> OFFLINE</div>

    <script>
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/v1/display/sw.js'); }); }
        window.addEventListener('offline', () => document.getElementById('offline-indicator').classList.remove('hidden'));
        window.addEventListener('online', () => { document.getElementById('offline-indicator').classList.add('hidden'); location.reload(); });

        const schoolId = "{{ school_id }}";
        const app = document.getElementById('app');
        let configData = null;
        let intervals = [];

        async function init() {
            try {
                const res = await fetch(`/v1/display/config?school_id=${schoolId}`);
                if (!res.ok) throw new Error("API Error");
                configData = await res.json();
                render();
            } catch (e) { setTimeout(init, 10000); }
        }

        function render() {
            app.innerHTML = '';
            intervals.forEach(clearInterval);
            intervals = [];

            const layoutType = configData.layout_type;
            let gridClass = 'grid-cols-1';
            let slotSpans = [];

            if (layoutType === 2) {
                gridClass = 'grid-cols-2';
                slotSpans = ['', ''];
            } else if (layoutType === 3) {
                gridClass = 'grid-cols-3';
                slotSpans = ['', '', ''];
            } else if (layoutType === 4) {
                gridClass = 'grid-cols-2 grid-rows-2';
                slotSpans = ['', '', '', ''];
            } else if (layoutType === 5) {
                // 等分割 5 (上2下3)
                gridClass = 'grid-cols-6 grid-rows-2';
                slotSpans = ['col-span-3', 'col-span-3', 'col-span-2', 'col-span-2', 'col-span-2'];
            } else if (layoutType === 6) {
                gridClass = 'grid-cols-3 grid-rows-2';
                slotSpans = ['', '', '', '', '', ''];
            } else if (layoutType === 12) {
                // 上メイン2分割
                gridClass = 'grid-cols-1 grid-rows-4';
                slotSpans = ['row-span-3', 'row-span-1'];
            } else if (layoutType === 13) {
                // 左メイン3分割
                gridClass = 'grid-cols-3 grid-rows-2';
                slotSpans = ['col-span-2 row-span-2', '', ''];
            } else if (layoutType === 14) {
                // 上メイン4分割
                gridClass = 'grid-cols-3 grid-rows-3';
                slotSpans = ['col-span-3 row-span-2', '', '', ''];
            } else if (layoutType === 15) {
                // 上メイン5分割
                gridClass = 'grid-cols-4 grid-rows-3';
                slotSpans = ['col-span-4 row-span-2', '', '', '', ''];
            } else if (layoutType === 16) {
                // 左メイン6分割
                gridClass = 'grid-cols-4 grid-rows-4';
                slotSpans = ['col-span-3 row-span-4', '', '', '', ''];
            }

            app.className = `h-full w-full grid gap-2 p-2 bg-black ${gridClass}`;

            configData.slots.forEach((slot, index) => {
                const el = document.createElement('div');
                const spanClass = slotSpans[index] || '';
                el.className = `slot-container bg-gray-900 rounded-xl overflow-hidden shadow-lg border border-gray-800 ${spanClass}`;
                
                const type = slot.content_type;
                const content = slot.content || {};

                if (type === 'ad' && content.slideshow && content.slideshow.length > 0) {
                    content.slideshow.forEach((url, idx) => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = `slide ${idx === 0 ? 'active' : ''}`;
                        el.appendChild(img);
                    });
                    if (content.slideshow.length > 1) {
                        let current = 0;
                        const duration = content.duration || 10000;
                        const slides = el.querySelectorAll('.slide');
                        const iv = setInterval(() => {
                            slides[current].classList.remove('active');
                            current = (current + 1) % slides.length;
                            slides[current].classList.add('active');
                        }, duration);
                        intervals.push(iv);
                    }
                } else if (type === 'countdown' && content.target_time) {
                    el.innerHTML = `
                        <div class="content-wrap bg-gradient-to-br from-purple-900 to-indigo-900">
                            <div class="text-title text-white/80">${content.body || 'Countdown'}</div>
                            <div class="flex-grow flex items-center justify-center w-full">
                                <div class="font-black font-mono tracking-wider countdown-timer text-yellow-400 leading-none" style="font-size: min(10vw, 15vh);">--:--:--</div>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">Target: ${new Date(content.target_time).toLocaleString()}</div>
                        </div>
                    `;
                    const target = new Date(content.target_time).getTime();
                    const timerEl = el.querySelector('.countdown-timer');
                    const updateTimer = () => {
                        const now = new Date().getTime();
                        const diff = target - now;
                        if (diff < 0) {
                            timerEl.innerText = "FINISH";
                            timerEl.classList.add("animate-pulse", "text-red-500");
                            return;
                        }
                        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const s = Math.floor((diff % (1000 * 60)) / 1000);
                        if (d > 0) timerEl.innerText = `${d}日 ${h}時間`;
                        else timerEl.innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    };
                    updateTimer();
                    intervals.push(setInterval(updateTimer, 1000));
                } else if (type === 'wbgt') {
                    const level = content.level || 'safe';
                    const configs = {
                        safe: { color: 'bg-blue-600', icon: 'fa-face-smile', text: '安全' },
                        warning: { color: 'bg-yellow-500', icon: 'fa-face-flushed', text: '警戒', textCol: 'text-black' },
                        danger: { color: 'bg-red-600', icon: 'fa-triangle-exclamation', text: '危険', anim: 'animate-pulse' }
                    };
                    const c = configs[level] || configs.safe;
                    el.innerHTML = `
                        <div class="content-wrap ${c.color} ${c.textCol || 'text-white'}">
                            <div class="text-xl font-bold mb-2">熱中症警戒情報</div>
                            <div class="flex-grow flex flex-col items-center justify-center">
                                <i class="fa-regular ${c.icon} mb-4 ${c.anim || ''}" style="font-size: min(15vw, 20vh);"></i>
                                <div class="font-black" style="font-size: min(6vw, 8vh);">${c.text}</div>
                            </div>
                        </div>
                    `;
                } else if (type === 'emergency') {
                    el.innerHTML = `
                        <div class="content-wrap theme-urgent">
                            <i class="fa-solid fa-triangle-exclamation mb-4 text-yellow-300" style="font-size: min(15vw, 20vh);"></i>
                            <div class="font-black mb-4" style="font-size: min(5vw, 8vh);">緊急連絡</div>
                            <div class="font-bold border-4 border-white p-4 rounded-xl bg-red-800 w-full" style="font-size: min(4vw, 6vh);">${content.body}</div>
                        </div>
                    `;
                } else if ((type === 'bus' || type === 'train') && content.media_url) {
                    el.innerHTML = `
                        <div class="content-wrap bg-white text-gray-800">
                            <div class="text-title text-blue-600 flex items-center">
                                <i class="fa-solid ${type === 'bus' ? 'fa-bus' : 'fa-train'} mr-2"></i>
                                ${type === 'bus' ? 'バス' : '電車'}時刻表
                            </div>
                            <div class="image-wrapper"><img src="${content.media_url}" class="main-image"></div>
                            ${content.body ? `<div class="text-note text-gray-800 font-bold border border-yellow-400 bg-yellow-100">${content.body}</div>` : ''}
                        </div>
                    `;
                } else {
                    let bgClass = 'bg-gray-800';
                    if (type === 'weather') bgClass = 'bg-gradient-to-b from-blue-400 to-blue-600';
                    let html = `<div class="content-wrap ${bgClass}">`;
                    if (type === 'weather') {
                        html += `<div class="text-xl font-bold mb-2 flex-shrink-0"><i class="fa-solid fa-cloud-sun"></i> 天気予報</div>`;
                        if (content.body) html += `<div class="text-body flex-grow flex items-center justify-center font-bold text-2xl">${content.body}</div>`;
                    } else {
                        if (content.media_url) html += `<div class="image-wrapper"><img src="${content.media_url}" class="main-image"></div>`;
                        if (content.body) html += `<div class="text-body mt-2 text-base">${content.body}</div>`;
                        else if (!content.media_url) html += `<div class="text-gray-500">情報がありません</div>`;
                    }
                    html += `</div>`;
                    el.innerHTML = html;
                }
                app.appendChild(el);
            });
        }

        function connectWs() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${schoolId}`;
            const ws = new WebSocket(wsUrl);
            ws.onmessage = (event) => { if (event.data === "RELOAD") init(); };
            ws.onclose = () => setTimeout(connectWs, 5000);
        }

        init();
        if (navigator.onLine) connectWs();
        setInterval(init, 60000);
    </script>
</body>
</html>